{% extends "base.html" %}
{% load static %}

{% block title %}
    {{ course_modules_lessons_video.0.title }} - Watch
{% endblock title %}

{% block content %}
    {% include "banner/banner.html" %}

    <div class="container mx-auto p-5">
        {% if course_modules_lessons_video %}
            {% with course=course_modules_lessons_video.0 modules=course_modules_lessons_video.1 lessons=course_modules_lessons_video.2 videos=course_modules_lessons_video.3 %}
            
                <div class="flex flex-col lg:flex-row lg:space-x-5">
                    <!-- Video Player Section -->
                    <div class="lg:w-2/3 md:w-full">
                        <h2 class="text-2xl font-semibold text-center mt-4">{{ course.title }} - Modules</h2>

                        <!-- Display the embedded video -->
                        <div class="mt-5">
                            {{ video_embed_html|safe }}
                        </div>
                    </div>

                    <!-- Modules and Lessons Section -->
                    <div class="lg:w-1/3 md:w-full">
                        <div class="max-w-full mx-4 p-6 bg-white border border-gray-200 rounded-lg shadow">
                            <p class="font-normal text-gray-700">{{ course.description }}</p>
                        </div>

                        <ul class="space-y-4 mt-4">
                            {% for module in modules %}
                                <li class="bg-white p-4 rounded-lg shadow-md">
                                    <div class="flex justify-between items-center">
                                        <button class="text-blue-700 hover:underline" onclick="toggleLessons('lessons-{{ module.id }}')">
                                            <h3 class="text-xl font-bold">{{ module.title }}</h3>
                                        </button>
                                    </div>

                                    <ul id="lessons-{{ module.id }}" class="hidden p-3 space-y-3">
                                        {% for lesson in lessons %}
                                            {% if lesson.module == module %}
                                                <li>
                                                    {% if lesson.videos.exists %}
                                                        {% for video in lesson.videos.all %}
                                                            <div class="flex p-2 rounded hover:bg-gray-100">
                                                                <input id="radio-video-{{ video.id }}" name="video-radio" type="radio" value="{{ video.video.url }}"
                                                                       class="mr-2"
                                                                       onchange="playVideo(this)">
                                                                <label for="radio-video-{{ video.id }}" class="cursor-pointer">
                                                                    <strong>{{ video.title }}</strong>
                                                                    <p class="text-xs text-gray-500">Some helpful instruction here.</p>
                                                                </label>
                                                            </div>
                                                        {% endfor %}
                                                    {% else %}
                                                        <p>No videos available for this lesson.</p>
                                                    {% endif %}
                                                </li>
                                            {% endif %}
                                        {% endfor %}
                                    </ul>
                                </li>
                            {% empty %}
                                <li>No modules available.</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            
            {% endwith %}
        {% else %}
            <p>No modules or lessons found.</p>
        {% endif %}
    </div>

    <script>

    
$(document).ready(function() {
    let video = document.getElementById('demo-player');
    let lessonId = $('#demo-player').data('lesson-id');
    console.log(video);
    
    // When the video ends, send an AJAX request to mark the lesson as watched
    video.onended = function() {
        $.ajax({
            url: '/lessons/mark-watched/' + lessonId + '/',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}',
            },
            success: function(response) {
                alert('Lesson marked as watched. Progress: ' + response.progress + '%');
                // Optionally update a progress bar or notify the user about course completion
            },
            error: function(xhr, status, error) {
                alert('Error marking the lesson as watched.');
            }
        });
    };
});
        function toggleLessons(moduleId) {
            const lessonList = document.getElementById(moduleId);
            if (lessonList) {
                lessonList.classList.toggle('hidden');
            } else {
                console.error(`Lesson list with ID ${moduleId} not found.`);
            }
        }

        function playVideo(radio) {
            const videoUrl = radio.value;
            const videoElement = document.querySelector('video');

            if (!videoElement) {
                console.error('Video element not found');
                return;
            }

            const sourceElement = videoElement.querySelector('source');

            if (sourceElement) {
                // If the <source> tag exists, set its src attribute and load the video
                sourceElement.src = videoUrl;
                videoElement.load();
                videoElement.play();
            } else {
                // If there's no <source> tag (e.g., Cloudinary embed), set the video element's src directly
                videoElement.src = videoUrl;
                videoElement.load();
                videoElement.play();
            }
        }
      

    </script>
{% endblock content %}